# NutriCycle System Architecture - As Built

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NutriCycle Detection System                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Webcam     â”‚â”€â”€â”€â”€â–¶â”‚   Backend    â”‚â”€â”€â”€â”€â–¶â”‚   Frontend   â”‚
â”‚  (Camera)    â”‚     â”‚   (Python)   â”‚     â”‚    (HTML)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   Logs/Data  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Component Architecture

### 1. Video Capture Layer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      WebcamCapture Class        â”‚
â”‚  (detection/detector.py)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Opens camera (index 0)       â”‚
â”‚  â€¢ Captures frames at 640x480   â”‚
â”‚  â€¢ Runs at ~30 FPS              â”‚
â”‚  â€¢ Context manager support      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ BGR Frames
```

### 2. Detection Layer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      WasteDetector Class        â”‚
â”‚  (detection/detector.py)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Loads YOLOv8 model           â”‚
â”‚  â€¢ Runs inference on frames     â”‚
â”‚  â€¢ Maps classes to waste types  â”‚
â”‚  â€¢ Draws bounding boxes         â”‚
â”‚  â€¢ Tracks statistics            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ Annotated Frames + Detections
```

### 3. Streaming Layer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Flask Server (app.py)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Runs detection loop          â”‚
â”‚  â€¢ Encodes frames as JPEG       â”‚
â”‚  â€¢ Streams as MJPEG             â”‚
â”‚  â€¢ Provides REST API            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ HTTP Streams & JSON
```

### 4. Frontend Layer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Web Dashboard (index.html)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Displays video stream        â”‚
â”‚  â€¢ Shows statistics panel       â”‚
â”‚  â€¢ Control buttons              â”‚
â”‚  â€¢ Real-time updates            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. Logging Layer
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DetectionLogger Class         â”‚
â”‚   (detection/logger.py)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Logs all detections          â”‚
â”‚  â€¢ Saves to JSON files          â”‚
â”‚  â€¢ Provides summaries           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
Start
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks     â”‚
â”‚ "Start"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initialize      â”‚
â”‚ â€¢ Detector      â”‚
â”‚ â€¢ Webcam        â”‚
â”‚ â€¢ Logger        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection Loop  â”‚â—€â”€â”€â”€â”€â”€â”€â”
â”‚ (Background     â”‚       â”‚
â”‚  Thread)        â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 1. Capture      â”‚       â”‚
â”‚    Frame        â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 2. Run YOLO     â”‚       â”‚
â”‚    Inference    â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 3. Draw Boxes   â”‚       â”‚
â”‚    & Labels     â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 4. Update       â”‚       â”‚
â”‚    Statistics   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 5. Log          â”‚       â”‚
â”‚    Detections   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 6. Encode       â”‚       â”‚
â”‚    to JPEG      â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 7. Stream       â”‚       â”‚
â”‚    to Frontend  â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ 8. Sleep 30ms   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         (Loop continues)
```

---

## API Endpoints Architecture

```
Frontend                     Backend
   â”‚                            â”‚
   â”‚  GET /                     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Status check
   â”‚                            â”‚
   â”‚  POST /start_detection     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Start detection thread
   â”‚                            â”‚
   â”‚  GET /video_feed           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ MJPEG stream
   â”‚  â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚ (continuous)
   â”‚                            â”‚
   â”‚  GET /statistics           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Get current counts
   â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ JSON response
   â”‚  (every 2 seconds)         â”‚
   â”‚                            â”‚
   â”‚  POST /stop_detection      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Stop thread, save logs
   â”‚                            â”‚
   â”‚  POST /reset_statistics    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Reset counters
```

---

## File Dependencies

```
app.py
  â”‚
  â”œâ”€â–¶ detection/detector.py
  â”‚     â”œâ”€â–¶ ultralytics (YOLO)
  â”‚     â”œâ”€â–¶ opencv-python (cv2)
  â”‚     â””â”€â–¶ numpy
  â”‚
  â”œâ”€â–¶ detection/logger.py
  â”‚     â””â”€â–¶ json
  â”‚
  â””â”€â–¶ flask, flask-cors

index.html
  â”‚
  â””â”€â–¶ js/main.js
        â””â”€â–¶ Fetch API (built-in)
```

---

## Directory Structure (Runtime)

```
nutricycle-esp32-vision/
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app.py                    â† Main Flask server
â”‚   â”œâ”€â”€ detection/
â”‚   â”‚   â”œâ”€â”€ __init__.py          â† Package init
â”‚   â”‚   â”œâ”€â”€ detector.py          â† Detection engine
â”‚   â”‚   â””â”€â”€ logger.py            â† Logging system
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ best.pt              â† Custom model (if available)
â”‚   â”‚
â”‚   â””â”€â”€ logs/                     â† Auto-generated logs
â”‚       â””â”€â”€ detections_*.json    â† Session logs
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html               â† Dashboard UI
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ main.js              â† Frontend logic
â”‚
â””â”€â”€ [setup files]
```

---

## Threading Model

```
Main Thread                Background Thread
    â”‚                           â”‚
    â”‚ Initialize                â”‚
    â”‚ Flask Server              â”‚
    â”‚     â”‚                     â”‚
    â”‚     â”œâ”€ HTTP Handlers      â”‚
    â”‚     â”‚                     â”‚
    â”‚     â””â”€ Start Detection â”€â”€â–¶â”‚ Detection Loop
    â”‚                           â”‚   â”‚
    â”‚                           â”‚   â”œâ”€ Capture Frame
    â”‚                           â”‚   â”œâ”€ Run YOLO
    â”‚                           â”‚   â”œâ”€ Draw Boxes
    â”‚                           â”‚   â”œâ”€ Update Stats
    â”‚                           â”‚   â”œâ”€ Log Events
    â”‚                           â”‚   â””â”€ Encode Frame
    â”‚                           â”‚        â”‚
    â”‚   â—€â”€ Get Frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   (for streaming)         â”‚
    â”‚                           â”‚
    â”‚                           â”‚ (loops until
    â”‚                           â”‚  detection_active
    â”‚                           â”‚  is False)
```

---

## ESP32 Integration (Future)

### Current (Webcam)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webcam   â”‚â”€USBâ”€â–¶â”‚ Backend  â”‚â”€HTTPâ”€â–¶â”‚ Frontend â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Future (ESP32-CAM)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ESP32-CAM â”‚â”€WiFiâ”€â–¶â”‚ Backend  â”‚â”€HTTPâ”€â–¶â”‚ Frontend â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€â–¶ [Diverter Control] (Future Phase)
```

**Migration Steps:**
1. Replace `WebcamCapture(camera_index=0)` 
2. With `cv2.VideoCapture('http://ESP32_IP/stream')`
3. No other changes needed!

---

## Performance Characteristics

### Latency Breakdown
```
Total Frame Latency: ~100ms
â”‚
â”œâ”€ Camera Capture:      10ms
â”œâ”€ YOLO Inference:      60ms
â”œâ”€ Post-processing:     10ms
â”œâ”€ Encoding (JPEG):     15ms
â””â”€ Network Transfer:     5ms
```

### Memory Usage
```
Total: ~800MB
â”‚
â”œâ”€ Python Runtime:     100MB
â”œâ”€ YOLOv8 Model:      300MB
â”œâ”€ OpenCV:            200MB
â”œâ”€ Frame Buffers:     100MB
â””â”€ Flask + Other:     100MB
```

---

## Error Handling Flow

```
Try Operation
    â”‚
    â–¼
  Error?
    â”‚
    â”œâ”€ Yes â”€â–¶ Log Error
    â”‚           â”‚
    â”‚           â–¼
    â”‚         Return Safe Default
    â”‚           â”‚
    â”‚           â–¼
    â”‚         Continue Operation
    â”‚
    â””â”€ No â”€â”€â–¶ Process Normally
```

---

## This Architecture Provides:

âœ… **Modularity** - Easy to swap components
âœ… **Scalability** - Can handle multiple cameras
âœ… **Maintainability** - Clear separation of concerns
âœ… **Extensibility** - Easy to add features
âœ… **Testability** - Components can be tested independently
âœ… **Performance** - Optimized for real-time processing
âœ… **Reliability** - Error handling at every layer

---

**System Architecture: Complete and Operational! ğŸš€**
