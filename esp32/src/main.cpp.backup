#include "esp_camera.h"
#include <WiFi.h>
#include "esp_http_server.h"

// ====== WiFi ======
const char* ssid = "2.4G_Jacobe";
const char* password = "0909123jab";

// const char* ssid = "POCO M7 Pro 5G";
// const char* password = "12345678";

// ====== Camera Config ======
camera_config_t camera_cfg;

// High FPS stream handler
static esp_err_t stream_handler(httpd_req_t *req) {
  camera_fb_t *fb = NULL;
  esp_err_t res = ESP_OK;
  size_t _jpg_buf_len;
  uint8_t *_jpg_buf;
  char part_buf[64];
  
  Serial.println("Stream connected!");
  
  res = httpd_resp_set_type(req, "multipart/x-mixed-replace;boundary=frame");
  if (res != ESP_OK) {
    Serial.println("Set type failed");
    return res;
  }

  unsigned long frame_count = 0;
  unsigned long last_fps_time = millis();
  
  while (true) {
    fb = esp_camera_fb_get();
    if (!fb) {
      Serial.println("FB get failed");
      res = ESP_FAIL;
      break;
    }
    
    _jpg_buf_len = fb->len;
    _jpg_buf = fb->buf;

    // Send all data in larger chunks for efficiency
    size_t hlen = snprintf(part_buf, 64, "--frame\r\nContent-Type: image/jpeg\r\nContent-Length: %u\r\n\r\n", _jpg_buf_len);
    
    // Try to send header + data together when possible
    res = httpd_resp_send_chunk(req, part_buf, hlen);
    if (res == ESP_OK) {
      res = httpd_resp_send_chunk(req, (const char *)_jpg_buf, _jpg_buf_len);
    }
    if (res == ESP_OK) {
      res = httpd_resp_send_chunk(req, "\r\n", 2);
    }
    
    esp_camera_fb_return(fb);
    fb = NULL;
    
    if (res != ESP_OK) {
      Serial.printf("Send failed, client disconnected\n");
      break;
    }
    
    frame_count++;
    if (millis() - last_fps_time >= 5000) {
      float fps = frame_count / 5.0;
      int rssi = WiFi.RSSI();
      Serial.printf("FPS: %.1f | RSSI: %d dBm", fps, rssi);
      if (rssi < -60) Serial.print(" [WEAK SIGNAL!]");
      Serial.println();
      frame_count = 0;
      last_fps_time = millis();
    }
  }
  
  if (fb) {
    esp_camera_fb_return(fb);
  }
  
  Serial.println("Stream ended");
  return res;
}

// Root handler with controls
static esp_err_t root_handler(httpd_req_t *req) {
  Serial.println("Root accessed!");
  const char* html = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <title>ESP32-S3 CAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; text-align: center; margin: 20px; background: #1a1a1a; color: #fff; }
    h1 { color: #4CAF50; }
    .stream { max-width: 100%; height: auto; border: 3px solid #4CAF50; }
    .btn { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
    .btn:hover { background: #45a049; }
    .info { margin: 20px; padding: 10px; background: #333; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ðŸŽ¥ ESP32-S3 Camera Stream</h1>
  <div class="info">
    <p>Resolution: 320x240 (QVGA) | Quality: 20 | Optimized for Speed</p>
    <p>Stream URL: <a href="/stream" style="color: #4CAF50;">/stream</a></p>
  </div>
  <img src="/stream" class="stream">
  <div style="margin-top: 20px;">
    <button class="btn" onclick="location.reload()">Refresh</button>
    <button class="btn" onclick="window.open('/stream', '_blank')">Full Screen</button>
  </div>
</body>
</html>
)rawliteral";
  httpd_resp_send(req, html, HTTPD_RESP_USE_STRLEN);
  return ESP_OK;
}

void start_camera_server() {
  httpd_config_t config = HTTPD_DEFAULT_CONFIG();
  config.server_port = 80;
  config.ctrl_port = 32768;
  config.max_open_sockets = 2;  // Limit connections for stability
  config.max_uri_handlers = 4;
  config.stack_size = 8192;  // Smaller stack = less overhead
  config.task_priority = 6;  // Higher priority for streaming
  config.lru_purge_enable = true;
  config.recv_wait_timeout = 3;
  config.send_wait_timeout = 3;
  config.core_id = 1;  // Run on Core 1
  
  httpd_handle_t server = NULL;
  
  Serial.println("Starting HTTP server...");
  if (httpd_start(&server, &config) == ESP_OK) {
    httpd_uri_t root_uri = {
      .uri = "/",
      .method = HTTP_GET,
      .handler = root_handler,
      .user_ctx = NULL
    };
    httpd_register_uri_handler(server, &root_uri);
    
    httpd_uri_t stream_uri = {
      .uri = "/stream",
      .method = HTTP_GET,
      .handler = stream_handler,
      .user_ctx = NULL
    };
    httpd_register_uri_handler(server, &stream_uri);
    
    Serial.println("HTTP server started successfully");
  } else {
    Serial.println("HTTP server start failed!");
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n=== ESP32-S3 WROOM CAM START - OV2640 ===");
  
  // Check PSRAM
  Serial.printf("PSRAM: %d bytes free\n", ESP.getFreePsram());
  Serial.printf("Heap: %d bytes free\n", ESP.getFreeHeap());

  // ----- FREENOVE ESP32-S3 WROOM CAMERA PINS -----
  camera_cfg.pin_pwdn  = -1;
  camera_cfg.pin_reset = -1;
  camera_cfg.pin_xclk  = 15;   // CAM_XCLK

  camera_cfg.pin_sccb_sda = 4;  // CAM_SIOD
  camera_cfg.pin_sccb_scl = 5;  // CAM_SIOC

  camera_cfg.pin_d7 = 16;  // CAM_Y9
  camera_cfg.pin_d6 = 17;  // CAM_Y8
  camera_cfg.pin_d5 = 18;  // CAM_Y7
  camera_cfg.pin_d4 = 12;  // CAM_Y6
  camera_cfg.pin_d3 = 10;  // CAM_Y5
  camera_cfg.pin_d2 = 8;   // CAM_Y4
  camera_cfg.pin_d1 = 9;   // CAM_Y3
  camera_cfg.pin_d0 = 11;  // CAM_Y2

  camera_cfg.pin_vsync = 6;   // CAM_VSYNC
  camera_cfg.pin_href  = 7;   // CAM_HREF
  camera_cfg.pin_pclk  = 13;  // CAM_PCLK

  camera_cfg.ledc_timer   = LEDC_TIMER_0;
  camera_cfg.ledc_channel = LEDC_CHANNEL_0;

  camera_cfg.xclk_freq_hz = 20000000;  // 20MHz for higher FPS
  camera_cfg.pixel_format = PIXFORMAT_JPEG;

  // ----- High FPS settings -----
  camera_cfg.frame_size  = FRAMESIZE_QVGA;  // 320x240 - much faster streaming
  camera_cfg.jpeg_quality = 20;  // Higher = lower quality but much smaller files
  camera_cfg.fb_count    = 2;  // Double buffering
  camera_cfg.fb_location = CAMERA_FB_IN_PSRAM;
  camera_cfg.grab_mode   = CAMERA_GRAB_LATEST;

  // ====== INIT CAMERA ======
  Serial.println("Initializing camera...");
  esp_err_t err = esp_camera_init(&camera_cfg);
  if (err != ESP_OK) {
    Serial.printf("Camera init FAILED: 0x%x\n", err);
    while (true) { delay(1000); }
  }
  Serial.println("Camera init OK");
  
  // Wait for sensor to stabilize
  delay(500);
  
  // Minimal sensor config for best FPS
  sensor_t *s = esp_camera_sensor_get();
  if (s) {
    s->set_framesize(s, FRAMESIZE_QVGA);  // 320x240
    s->set_quality(s, 20);  // Higher = smaller files = faster streaming
    // Auto settings for stability
    s->set_whitebal(s, 1);      // Auto white balance
    s->set_awb_gain(s, 1);      // Auto WB gain
    s->set_gain_ctrl(s, 1);     // Auto gain
    s->set_exposure_ctrl(s, 1); // Auto exposure
    s->set_aec2(s, 1);          // Auto exposure DSP
    s->set_dcw(s, 1);           // Downsize enable
    s->set_bpc(s, 1);           // Black pixel cancel
    s->set_wpc(s, 1);           // White pixel cancel
  }

  // Discard first few frames (warmup)
  Serial.println("Warming up camera...");
  for (int i = 0; i < 3; i++) {
    camera_fb_t *fb = esp_camera_fb_get();
    if (fb) {
      esp_camera_fb_return(fb);
      Serial.printf("Warmup frame %d OK\n", i+1);
    } else {
      Serial.printf("Warmup frame %d FAILED\n", i+1);
    }
    delay(100);
  }
  
  // Test a single capture
  Serial.println("Testing single frame capture...");
  camera_fb_t *fb = esp_camera_fb_get();
  if (fb) {
    Serial.printf("Frame captured: %d bytes, %dx%d\n", fb->len, fb->width, fb->height);
    esp_camera_fb_return(fb);
  } else {
    Serial.println("TEST CAPTURE FAILED!");
  }

  // ====== WiFi ======
  WiFi.disconnect(true);
  delay(1000);
  WiFi.mode(WIFI_STA);
  
  Serial.printf("Connecting to SSID: %s\n", ssid);
  WiFi.begin(ssid, password);
  
  unsigned long startAttempt = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startAttempt < 15000) {
    delay(500);
    Serial.print(".");
    Serial.printf("[Status=%d]", WiFi.status());
  }
  Serial.println("");

  // Detailed connection status
  Serial.printf("WiFi Status Code: %d\n", WiFi.status());
  Serial.printf("  0=IDLE, 1=NO_SSID, 3=CONNECTED, 4=FAILED, 6=DISCONNECTED\n");
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("âœ“ WiFi CONNECTED!");
    Serial.printf("  IP: %s\n", WiFi.localIP().toString().c_str());
    Serial.printf("  Gateway: %s\n", WiFi.gatewayIP().toString().c_str());
    Serial.printf("  Subnet: %s\n", WiFi.subnetMask().toString().c_str());
    Serial.printf("  DNS: %s\n", WiFi.dnsIP().toString().c_str());
    Serial.printf("  RSSI: %d dBm\n", WiFi.RSSI());
    Serial.printf("  MAC: %s\n", WiFi.macAddress().c_str());
    Serial.printf("\nTest from PC: ping %s\n", WiFi.localIP().toString().c_str());
    Serial.printf("Stream URL: http://%s/stream\n", WiFi.localIP().toString().c_str());
  } else {
    Serial.println("âœ— WiFi CONNECTION FAILED!");
    Serial.println("Possible issues:");
    Serial.println("  - Wrong SSID/Password");
    Serial.println("  - Router client isolation ON");
    Serial.println("  - WPA3 or mixed mode (use WPA2-AES only)");
    Serial.println("  - Weak signal / too far");
    Serial.println("  - MAC filtering enabled");
    while(1) { delay(1000); }  // Stop here
  }

  // Start stream server
  start_camera_server();
}

void loop() {
  // Monitor WiFi connection status
  static unsigned long lastCheck = 0;
  if (millis() - lastCheck > 5000) {
    lastCheck = millis();
    Serial.printf("WiFi Status: %d | IP: %s | RSSI: %d dBm\n", 
                  WiFi.status(), 
                  WiFi.localIP().toString().c_str(), 
                  WiFi.RSSI());
  }
  delay(100);
}
